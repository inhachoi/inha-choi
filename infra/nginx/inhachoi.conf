# 1. HTTP 서버 (포트 80)
# - 모든 HTTP 요청을 받아서 HTTPS(443) + www 로 리다이렉트한다
server {
    listen 80; 
    # listen 80 = 'HTTP' 요청을 받는 포트 (기본 웹 포트)
    # 브라우저에서 http://gyeung-il.com 으로 들어오면 여기로 온다

    server_name gyeung-il.com www.gyeung-il.com;
    # 이 서버 블록이 처리할 도메인 이름
    # 두 개를 모두 적어야 www / non-www 모두 처리 가능

    # non-www → www 리다이렉트
    if ($host = gyeung-il.com) {
        return 301 https://www.gyeung-il.com$request_uri;
        # 301 = 영구 리다이렉트
        # request_uri = 원래 요청 경로(/api/test 같은 것)
    }

    return 301 https://$host$request_uri;
    # $host = 요청한 도메인 값 (www.gyeung-il.com)
    # HTTPS는 443 포트에서 처리하므로 다음 server 블록으로 넘어감
}

# 2. HTTPS 서버 (포트 443)
# - 모든 실제 서비스(React 빌드, API 프록시)가 이 서버에서 처리됨
server {
    listen 443 ssl http2;
    # listen 443 = 'HTTPS' 요청을 받는 포트
    # ssl = HTTPS 활성화
    # http2 = HTTP/2 프로토콜 사용

    server_name www.gyeung-il.com;
    # 대표 도메인을 www 버전으로 통일하려고 여기에만 설정

    # SSL 인증서 경로
    # certbot이 자동 생성해 둔 실제 인증서 파일 경로
    ssl_certificate /etc/letsencrypt/live/gyeung-il.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/gyeung-il.com/privkey.pem;
    # HTTPS 통신의 핵심: 공개키/개인키

    # React 빌드된 정적 파일 위치
    # Nginx가 직접 index.html, js, css 제공
    root /home/ubuntu/inha-choi/apps/front/dist;
    index index.html;

    # React SPA 라우팅
    # Vue/React/Next 등 프론트 SPA는
    # 실제 파일이 없어도 항상 index.html 로 보여줘야 함
    location / {
        try_files $uri /index.html;
        # 요청한 파일이 없으면 index.html 반환
    }
    
    # Express API 서버로 프록시
    # /api/* 요청은 3000번 포트 Node.js 서버로 전달
    location /api/ {
        proxy_pass http://localhost:3000; 
        # 프록시 대상: Node.js 서버 (pm2로 실행 중)

        proxy_http_version 1.1;
        # nginx → express 연결은 HTTP/1.1 을 사용해야 안정적

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        # WebSocket 같은 업그레이드 요청도 지원되도록 설정

        proxy_set_header Host $host;
        # 원래 요청된 Host 그대로 전달 (도메인 유지)

        proxy_cache_bypass $http_upgrade;
        # 캐싱 방지 (실시간 API 응답 위해)
    }
}
